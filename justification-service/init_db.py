#!/usr/bin/env python3
"""
Script d'initialisation de la base de donn√©es pour le service de justifications
"""
import os
import sys
import logging
from datetime import datetime, timedelta

# Ajouter le r√©pertoire app au path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.core.database import engine, SessionLocal, create_tables
from app.core.config import settings
from app.models.justification import *
from app.services.integration_service import IntegrationService


def test_database_connection():
    """Tester la connexion √† la base de donn√©es"""
    print("\nüìä Test de connexion √† la base de donn√©es...")
    try:
        from sqlalchemy import text
        with engine.connect() as connection:
            result = connection.execute(text("SELECT 1"))
            print("‚úÖ Connexion base de donn√©es r√©ussie")
            return True
    except Exception as e:
        print(f"‚ùå Erreur connexion base de donn√©es: {e}")
        return False


def create_sample_data():
    """Cr√©er des donn√©es d'exemple"""
    print("\nüë• Cr√©ation de donn√©es d'exemple...")
    
    try:
        db = SessionLocal()
        
        # V√©rifier si des donn√©es existent d√©j√†
        existing_count = db.query(Justification).count()
        if existing_count > 0:
            print(f"‚úÖ Donn√©es existantes trouv√©es ({existing_count} justifications)")
            db.close()
            return True
        
        # Cr√©er des templates de justification
        templates = [
            JustificationTemplate(
                name="Certificat m√©dical",
                description="Justification pour absence m√©dicale",
                justification_type=JustificationType.MEDICAL,
                title_template="Absence pour raison m√©dicale",
                description_template="Je soussign√©(e) certifie que l'√©tudiant(e) √©tait dans l'impossibilit√© de se pr√©senter en cours pour raison m√©dicale.",
                default_priority=JustificationPriority.HIGH,
                requires_documents=True,
                max_absence_days=7,
                created_by="system"
            ),
            JustificationTemplate(
                name="Probl√®me de transport",
                description="Justification pour probl√®me de transport",
                justification_type=JustificationType.TRANSPORT,
                title_template="Retard/Absence due √† un probl√®me de transport",
                description_template="En raison d'un probl√®me de transport (gr√®ve, panne, accident), je n'ai pas pu me pr√©senter en cours.",
                default_priority=JustificationPriority.MEDIUM,
                requires_documents=False,
                max_absence_days=1,
                created_by="system"
            ),
            JustificationTemplate(
                name="√âv√©nement familial",
                description="Justification pour √©v√©nement familial",
                justification_type=JustificationType.FAMILY,
                title_template="Absence pour √©v√©nement familial",
                description_template="Je sollicite une autorisation d'absence pour un √©v√©nement familial important.",
                default_priority=JustificationPriority.MEDIUM,
                requires_documents=True,
                max_absence_days=3,
                created_by="system"
            )
        ]
        
        for template in templates:
            db.add(template)
        
        # Cr√©er des justifications d'exemple
        sample_justifications = [
            Justification(
                student_id="student_001",
                course_id=1,
                title="Absence pour rendez-vous m√©dical",
                description="Rendez-vous m√©dical urgent chez le dentiste. Certificat m√©dical fourni.",
                justification_type=JustificationType.MEDICAL,
                priority=JustificationPriority.HIGH,
                absence_start_date=datetime.now() - timedelta(days=2),
                absence_end_date=datetime.now() - timedelta(days=2),
                status=JustificationStatus.ADMIN_APPROVED,
                parent_approval_required=True,
                admin_validation_required=True,
                parent_approved_by="parent_001",
                parent_approved_at=datetime.now() - timedelta(days=1),
                admin_validated_by="admin_001",
                admin_validated_at=datetime.now() - timedelta(hours=2),
                submission_deadline=datetime.now() + timedelta(days=5),
                expires_at=datetime.now() + timedelta(days=28),
                created_by="student_001",
                notes="Certificat m√©dical en pi√®ce jointe"
            ),
            Justification(
                student_id="student_002",
                course_id=2,
                title="Retard d√ª √† une gr√®ve des transports",
                description="Gr√®ve SNCF, impossible d'arriver √† l'heure pour le cours de 8h.",
                justification_type=JustificationType.TRANSPORT,
                priority=JustificationPriority.MEDIUM,
                absence_start_date=datetime.now() - timedelta(days=1),
                absence_end_date=datetime.now() - timedelta(days=1),
                status=JustificationStatus.PARENT_PENDING,
                parent_approval_required=True,
                admin_validation_required=True,
                submission_deadline=datetime.now() + timedelta(days=6),
                expires_at=datetime.now() + timedelta(days=29),
                created_by="student_002"
            ),
            Justification(
                student_id="student_003",
                course_id=1,
                title="Absence pour mariage familial",
                description="Mariage de ma s≈ìur, √©v√©nement familial important n√©cessitant ma pr√©sence.",
                justification_type=JustificationType.FAMILY,
                priority=JustificationPriority.MEDIUM,
                absence_start_date=datetime.now() + timedelta(days=7),
                absence_end_date=datetime.now() + timedelta(days=8),
                status=JustificationStatus.DRAFT,
                parent_approval_required=True,
                admin_validation_required=True,
                submission_deadline=datetime.now() + timedelta(days=14),
                expires_at=datetime.now() + timedelta(days=37),
                created_by="student_003",
                notes="Faire-part de mariage en pi√®ce jointe"
            )
        ]
        
        for justification in sample_justifications:
            db.add(justification)
        
        db.commit()
        
        # Cr√©er l'historique pour les justifications
        for i, justification in enumerate(sample_justifications, 1):
            db.refresh(justification)
            
            # Historique de cr√©ation
            history_created = JustificationHistory(
                justification_id=justification.id,
                action="created",
                old_status=None,
                new_status=JustificationStatus.DRAFT.value,
                comment="Justification cr√©√©e",
                changed_by=justification.created_by
            )
            db.add(history_created)
            
            # Historique suppl√©mentaire pour les justifications non-draft
            if justification.status != JustificationStatus.DRAFT:
                history_submitted = JustificationHistory(
                    justification_id=justification.id,
                    action="submitted",
                    old_status=JustificationStatus.DRAFT.value,
                    new_status=JustificationStatus.PARENT_PENDING.value,
                    comment="Justification soumise pour approbation",
                    changed_by=justification.created_by
                )
                db.add(history_submitted)
                
                if justification.parent_approved_by:
                    history_parent = JustificationHistory(
                        justification_id=justification.id,
                        action="parent_approved",
                        old_status=JustificationStatus.PARENT_PENDING.value,
                        new_status=JustificationStatus.ADMIN_PENDING.value,
                        comment="Approuv√© par les parents",
                        changed_by=justification.parent_approved_by
                    )
                    db.add(history_parent)
                
                if justification.admin_validated_by:
                    history_admin = JustificationHistory(
                        justification_id=justification.id,
                        action="admin_approved",
                        old_status=JustificationStatus.ADMIN_PENDING.value,
                        new_status=JustificationStatus.ADMIN_APPROVED.value,
                        comment="Valid√© par l'administration",
                        changed_by=justification.admin_validated_by
                    )
                    db.add(history_admin)
        
        db.commit()
        db.close()
        
        print("‚úÖ Donn√©es d'exemple cr√©√©es")
        print("   - 3 templates de justification")
        print("   - 3 justifications d'exemple")
        print("   - Historique des modifications")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur cr√©ation donn√©es d'exemple: {e}")
        return False


def test_integration_services():
    """Tester l'int√©gration avec les autres services"""
    print("\nüîó Test d'int√©gration avec les autres services...")
    
    integration_service = IntegrationService()
    services = {
        "auth-service": "auth",
        "user-service": "user", 
        "course-service": "course",
        "attendance-service": "attendance"
    }
    
    available_services = 0
    
    for service_name, service_key in services.items():
        try:
            is_available = integration_service.is_service_available(service_key)
            status = "‚úÖ" if is_available else "‚ùå"
            print(f"   {status} {service_name}: {'Disponible' if is_available else 'Non disponible'}")
            if is_available:
                available_services += 1
        except Exception as e:
            print(f"   ‚ùå {service_name}: Erreur - {e}")
    
    print(f"\nüìà Services disponibles: {available_services}/{len(services)}")
    
    if available_services == 0:
        print("‚ö†Ô∏è  Aucun service externe disponible - Le service fonctionnera en mode autonome")
    
    return available_services > 0


def main():
    """Fonction principale d'initialisation"""
    print("üöÄ Initialisation du service de justifications PresencePro")
    print("=" * 70)
    print(f"üìä Base de donn√©es: {settings.database_url}")
    
    # Test de connexion
    if not test_database_connection():
        print("üí• √âchec de l'initialisation - Probl√®me de base de donn√©es")
        return False
    
    # Cr√©ation des tables
    print("\nüîß Cr√©ation des tables de base de donn√©es...")
    try:
        create_tables()
        print("‚úÖ Tables cr√©√©es avec succ√®s")
    except Exception as e:
        print(f"‚ùå Erreur cr√©ation tables: {e}")
        return False
    
    # Test d'int√©gration
    test_integration_services()
    
    # Cr√©ation des donn√©es d'exemple
    if not create_sample_data():
        print("üí• √âchec de l'initialisation - Probl√®me cr√©ation donn√©es")
        return False
    
    # Cr√©er le r√©pertoire d'upload
    print("\nüìÅ Configuration du r√©pertoire d'upload...")
    try:
        os.makedirs(settings.upload_dir, exist_ok=True)
        print(f"‚úÖ R√©pertoire d'upload cr√©√©: {settings.upload_dir}")
    except Exception as e:
        print(f"‚ùå Erreur cr√©ation r√©pertoire upload: {e}")
    
    print("\nüéâ Initialisation termin√©e avec succ√®s!")
    print("\nüìù Prochaines √©tapes:")
    print("   1. Lancez le service: uvicorn app.main:app --reload --port 8006")
    print("   2. Testez l'API: http://localhost:8006/docs")
    print("   3. Cr√©ez une justification: POST /api/v1/justifications/create")
    print("   4. Consultez le statut: GET /api/v1/justifications/status/{id}")
    print("\nüéä Service de justifications pr√™t √† √™tre utilis√©!")
    
    return True


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
